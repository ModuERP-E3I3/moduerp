<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BuyStockMapper">

    <!-- BuyStockIn에 대한 resultMap -->
    <resultMap id="resultBuyStockIn" type="com.e3i3.moduerp.buystock.model.dto.BuyStockInDTO">
        <result property="bStockInId" column="B_STOCK_IN_ID" />
        <result property="itemCode" column="ITEM_CODE" />
        <result property="uuid" column="UUID" />
        <result property="accountNo" column="ACCOUNT_NO" />
        <result property="orderId" column="ORDER_ID" />
        <result property="bStockInDate" column="B_STOCK_IN_DATE" />
        <result property="bStockInPlace" column="B_STOCK_IN_PLACE" />
        <result property="bStockInQty" column="B_STOCK_IN_QTY" />
        <result property="empName" column="EMP_NAME" /> 
        <result property="accountName" column="ACCOUNT_NAME" /> <!-- ACCOUNT_NAME 추가 -->
    </resultMap>
    
    <!-- BUY_STOCK_IN에서 ITEM과 EMPLOYEE 테이블을 조인하여 필요한 데이터 가져오기 -->
    <select id="getBuyStockInWithDetails" resultMap="resultBuyStockIn">
        SELECT 
            BSI.B_STOCK_IN_ID,
            BSI.ITEM_CODE,
            BSI.UUID,
            BSI.ORDER_ID,
            BSI.B_STOCK_IN_DATE,
            BSI.B_STOCK_IN_PLACE,
            BSI.B_STOCK_IN_QTY,
            AC.ACCOUNT_NAME,
            E.EMP_NAME
        FROM 
            BUY_STOCK_IN BSI
        LEFT JOIN 
            ITEM I ON BSI.ITEM_CODE = I.ITEM_CODE
        LEFT JOIN 
            ACCOUNT AC ON BSI.ACCOUNT_NO = AC.ACCOUNT_NO
        LEFT JOIN 
            EMPLOYEE E ON BSI.UUID = E.UUID
           WHERE i.BIZ_NUMBER = #{bizNumber}
    </select>

    <!-- 새로운 구매 입고 데이터를 삽입하는 쿼리 -->
    <insert id="insertBuyStockIn">
        INSERT INTO BUY_STOCK_IN (B_STOCK_IN_ID,
        ITEM_CODE, B_STOCK_IN_DATE,
        B_STOCK_IN_PLACE, B_STOCK_IN_QTY, UUID, ACCOUNT_NO)
        VALUES
        (#{bStockInId}, #{itemCode}, #{bStockInDate}, #{bStockInPlace},
        #{bStockInQty}, #{uuid}, #{accountNo})
    </insert>

    <select id="selectBuyStockInByItemCode"
        parameterType="String"
        resultType="com.e3i3.moduerp.buystock.model.dto.BuyStockInDTO">
        SELECT *
        FROM ITEM
        WHERE BIZ_NUMBER = #{bizNumber} AND ITEM_CODE LIKE CONCAT(#{bizNumber}, 'B%')
    </select>

    <update id="updateBuyStockIn"
        parameterType="com.e3i3.moduerp.buystock.model.dto.BuyStockInDTO">
        UPDATE BUY_STOCK_IN
        SET B_STOCK_IN_PLACE = #{bStockPlace}, B_STOCK_IN_QTY = #{bStockInQty}
        WHERE ITEM_CODE = #{itemCode}
    </update>

    <delete id="deleteBuyStockInByItemCode"
        parameterType="String">
        DELETE FROM BUY_STOCK_IN WHERE ITEM_CODE = #{itemCode}
    </delete>
</mapper>
